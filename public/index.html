<!doctype html>
<html>
    <head>
        <title>VideoChat</title>

        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0"/>

        <link rel="stylesheet" type="text/css" href="css/styles.css">
        <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    </head>
    <body style="overflow: hidden">
        <div id="nickWrap">
                <form id="setNick" class="form-signin">
                    <h3 class="form-signin-heading">Insira um username</h3>
                    <input size=35 id="nickname" class="form-control"></input><br>
                    <input type="submit" class="btn btn-lg btn-info btn-block"></input>
                    <h5 id="nickError"></h5>
                </form>
        </div>
        <div id="contentWrap">
            <span style="font-size:30px;cursor:pointer" onclick="sidenavToggle()" id="open">&#9776;</span>

            <div class="sidenav" id="tt">
                <div class="panel panel-info">
                    <div class="panel-heading">
                        ONLINE USERS
                    </div>
                    <div class="panel-body">
                        <ul class="media-list"  id="user" style="cursor: default" >
                            <!-- Users -->
                        </ul>

                    </div>
                </div>
            </div>
            <div class="col-md-4 col-sm-4" id="chatWrap">
                <div class="panel panel-info">
                    <div class="panel-heading" style="cursor: default">
                        CHAT
                        <span id="minimize" class="glyphicon glyphicon-minus minimize"></span>
                    </div>
                    <div class="panel-body" id="chatmsg">
                        <ul class="media-list" id="mensagem">
                            <!-- Mensagem -->
                        </ul>
                    </div>
                    <div class="panel-footer">
                        <div class="input-group">
                            <form action="" id="chatform">
                                <input id="mm" type="text" autocomplete="off" class="form-control" placeholder="Enter Message" /> 
                            </form>
                            <span class="input-group-btn">
                                <button id="bt" class="btn btn-info" type="submit">SEND</button>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <img src="images/msg.png" id="chat" class="minimize">
            <!--<div id="logout"><button onclick="Logout();">Logout</button></div>-->
        </div>
        
    </body>

    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>

        var socket = io();

        function sidenavToggle(){
            if(document.getElementById("tt").style.width == "250px"){
                document.getElementById("tt").style.width = "0";
                document.getElementById("open").style.marginLeft = "0";
            }
            else{
                 document.getElementById("tt").style.width = "250px";
                document.getElementById("open").style.marginLeft = "250px";
            }
        }
        $( window ).resize(function() {
            if ($(window).width() > 768) {
                document.getElementById("tt").style.width = "250px";
                document.getElementById("open").style.marginLeft = "250px";
            }
            else{
                document.getElementById("tt").style.width = "0px";
                document.getElementById("open").style.marginLeft = "0px";
            }
        });

        function Logout(){
            window.location.reload();
        };

        $('#contentWrap').show(); 

        $('#setNick').submit(function(e){
            e.preventDefault();
            socket.emit('novo user', $('#nickname').val(), function(data){
                if(data){
                    $('#nickWrap').hide();
                    $('#contentWrap').show();
                }
                else{
                    $('#nickError').html('Esse utilizador ja foi usado, tente novamente');
                }
            });
             $('#nickname').val('');
        });

        socket.on('usernames', function(data){
            var html = '';
            for(i=0; i < data.length; i++){
                html += '<li class="media">\
                        <div class="media-body">\
                        <div class="media">\
                        <img class="pull-left" class="media-object img-circle" style="max-height:15px;" src="images/on.png" />\
                        <div class="media-body" >\
                        <h5>' + data[i] + '</h5>\
                        </div></div></div></li>'
            }
            $('#user').html(html);
        })
        
        $(".minimize").click(function(){
            $("#chatWrap").slideToggle(280);
        });


        $('#bt').click(function(){
           $('#chatform').submit(); 
        });

        $('#chatform').submit(function(){
            if($('#mm').val() !=  ""){
                socket.emit('chat message', $('#mm').val());
                $('#mm').val('');
            }
            return false;
        });

        socket.on('chat message', function(msg){
            console.log(msg.msn);
            var txt = '<li class="media"> \
                            <div class="media-body"> \
                                <div class="media"> \
                                    <b>' + msg.nick + ':</b> \
                                    <div class="media-body" > \
                                        ' + msg.msn + ' \
                                        <hr /> \
                                    </div> \
                                </div> \
                            </div> \
                        </li>'
            $('#mensagem').append(txt);
            $("#chatmsg").scrollTop(($("#chatmsg")[0].scrollHeight)+100);
        });

        /*socket.on('disconnect', function(){
            alert('Pedimos desculpa, o servidor desconectou-se');
        });*/
    </script>
</html>
